package controllers

import (
	"github.com/emmadal/feeti-backend-user/helpers"
	"github.com/emmadal/feeti-backend-user/models"
	"github.com/gin-gonic/gin"
	"net/http"
)

// UpdateProfile updates user profile
func UpdateProfile(c *gin.Context) {
	var body models.Profile

	// Validate request body
	if err := c.ShouldBindJSON(&body); err != nil {
		helpers.HandleError(c, http.StatusBadRequest, "Bad request", err)
		return
	}

	// search if user exists in DB
	if exist := models.CheckUserByPhone(body.PhoneNumber); !exist {
		helpers.HandleError(c, http.StatusNotFound, "request not found", nil)
		return
	}

	// Fetch user from database
	updatedUser, err := body.UpdateProfile()
	if err != nil {
		helpers.HandleError(c, http.StatusInternalServerError, err.Error(), err)
		return
	}

	// Send success response
	helpers.HandleSuccessData(
		c, "User profile updated successfully", map[string]any{
			"user": gin.H{
				"id":           updatedUser.ID,
				"phone_number": updatedUser.PhoneNumber,
				"first_name":   updatedUser.FirstName,
				"last_name":    updatedUser.LastName,
				"photo":        updatedUser.Photo,
				"face_id":      updatedUser.FaceID,
				"finger_print": updatedUser.FingerPrint,
				"premium":      updatedUser.Premium,
				"device_token": updatedUser.DeviceToken,
			},
		},
	)
}
